import{_ as i,c,d as e,e as a,f as s,b as p,w as l,r as o,o as u}from"./app-DyGs7pMe.js";const r={};function d(k,n){const t=o("RouteLink");return u(),c("div",null,[n[5]||(n[5]=e(`<h1 id="_06-rabbitmqé¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#_06-rabbitmqé¢è¯•é¢˜"><span>06 - RabbitMQé¢è¯•é¢˜</span></a></h1><h2 id="ğŸ¯-åŸºç¡€çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-åŸºç¡€çŸ¥è¯†"><span>ğŸ¯ åŸºç¡€çŸ¥è¯†</span></a></h2><h3 id="_1-ä»€ä¹ˆæ˜¯rabbitmq-æœ‰ä»€ä¹ˆç‰¹ç‚¹" tabindex="-1"><a class="header-anchor" href="#_1-ä»€ä¹ˆæ˜¯rabbitmq-æœ‰ä»€ä¹ˆç‰¹ç‚¹"><span>1. ä»€ä¹ˆæ˜¯RabbitMQï¼Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong> RabbitMQæ˜¯åŸºäºAMQPåè®®çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œä½¿ç”¨Erlangè¯­è¨€å¼€å‘ã€‚</p><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li>å¯é æ€§ï¼šæŒä¹…åŒ–ã€ç¡®è®¤æœºåˆ¶ã€é•œåƒé˜Ÿåˆ—</li><li>çµæ´»è·¯ç”±ï¼šå¤šç§äº¤æ¢æœºç±»å‹</li><li>é«˜å¯ç”¨ï¼šé›†ç¾¤ã€é•œåƒé˜Ÿåˆ—</li><li>å¤šè¯­è¨€æ”¯æŒï¼šJavaã€Pythonã€Goç­‰</li><li>ç®¡ç†ç•Œé¢ï¼šWebæ§åˆ¶å°</li><li>æ’ä»¶ç³»ç»Ÿï¼šä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€</li></ul><h3 id="_2-rabbitmqçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_2-rabbitmqçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›"><span>2. RabbitMQçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><table><thead><tr><th>æ¦‚å¿µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Producer</td><td>æ¶ˆæ¯ç”Ÿäº§è€…</td></tr><tr><td>Consumer</td><td>æ¶ˆæ¯æ¶ˆè´¹è€…</td></tr><tr><td>Exchange</td><td>äº¤æ¢æœºï¼Œè´Ÿè´£è·¯ç”±æ¶ˆæ¯</td></tr><tr><td>Queue</td><td>é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯</td></tr><tr><td>Binding</td><td>ç»‘å®šï¼ŒExchangeå’ŒQueueçš„å…³ç³»</td></tr><tr><td>Routing Key</td><td>è·¯ç”±é”®</td></tr><tr><td>Virtual Host</td><td>è™šæ‹Ÿä¸»æœºï¼Œéš”ç¦»</td></tr><tr><td>Connection</td><td>TCPè¿æ¥</td></tr><tr><td>Channel</td><td>ä¿¡é“ï¼Œå¤ç”¨è¿æ¥</td></tr></tbody></table><h3 id="_3-rabbitmqçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_3-rabbitmqçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›"><span>3. RabbitMQçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. Directï¼ˆç›´è¿ï¼‰</strong></p><ul><li>ç²¾ç¡®åŒ¹é…routing key</li><li>é€‚ç”¨åœºæ™¯ï¼šé”™è¯¯æ—¥å¿—è·¯ç”±</li></ul><p><strong>2. Fanoutï¼ˆå¹¿æ’­ï¼‰</strong></p><ul><li>å‘é€åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—</li><li>é€‚ç”¨åœºæ™¯ï¼šç¾¤å‘é€šçŸ¥</li></ul><p><strong>3. Topicï¼ˆä¸»é¢˜ï¼‰</strong></p><ul><li>æ¨¡å¼åŒ¹é…ï¼ˆ<code>*</code>åŒ¹é…ä¸€ä¸ªå•è¯ï¼Œ<code>#</code>åŒ¹é…å¤šä¸ªï¼‰</li><li>é€‚ç”¨åœºæ™¯ï¼šå¤æ‚è·¯ç”±è§„åˆ™</li></ul><p><strong>4. Headersï¼ˆå¤´éƒ¨ï¼‰</strong></p><ul><li>æ ¹æ®æ¶ˆæ¯å¤´å±æ€§åŒ¹é…</li><li>ä½¿ç”¨è¾ƒå°‘</li></ul><h3 id="_4-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±" tabindex="-1"><a class="header-anchor" href="#_4-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±"><span>4. å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼šä¸‰ä¸ªé˜¶æ®µä¿è¯</strong></p><p><strong>1. ç”Ÿäº§è€…åˆ°Exchange</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// å¼€å¯å‘é€æ–¹ç¡®è®¤</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. Exchangeåˆ°Queue</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// æ¶ˆæ¯æŒä¹…åŒ–</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queue<span class="token punctuation">,</span> </span>
<span class="line">    <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_TEXT_PLAIN</span><span class="token punctuation">,</span> </span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. Queueåˆ°Consumer</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// æ‰‹åŠ¨ACK</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> cancelCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹" tabindex="-1"><a class="header-anchor" href="#_5-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹"><span>5. å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼šå®ç°å¹‚ç­‰æ€§</strong></p><p><strong>æ–¹å¼1ï¼šä½¿ç”¨å”¯ä¸€ID</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.queue&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> messageId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Rediså»é‡</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>messageId<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¤„ç†æ¶ˆæ¯</span></span>
<span class="line">        <span class="token function">processMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ–¹å¼2ï¼šæ•°æ®åº“å”¯ä¸€ç´¢å¼•</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_order_id <span class="token keyword">ON</span> orders<span class="token punctuation">(</span>order_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—-æœ‰ä»€ä¹ˆç”¨" tabindex="-1"><a class="header-anchor" href="#_6-ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—-æœ‰ä»€ä¹ˆç”¨"><span>6. ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>æ­»ä¿¡ï¼ˆDead Letterï¼‰äº§ç”ŸåŸå› ï¼š</strong></p><ul><li>æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆbasic.reject/basic.nackï¼‰ä¸”requeue=false</li><li>æ¶ˆæ¯TTLè¿‡æœŸ</li><li>é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦</li></ul><p><strong>ç”¨é€”ï¼š</strong></p><ul><li>å¼‚å¸¸æ¶ˆæ¯å¤„ç†</li><li>å»¶è¿Ÿé˜Ÿåˆ—å®ç°</li><li>æ¶ˆæ¯é‡è¯•</li></ul><p><strong>é…ç½®ç¤ºä¾‹ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dlx.exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dlx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;normal.queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”¥-è¿›é˜¶é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ğŸ”¥-è¿›é˜¶é—®é¢˜"><span>ğŸ”¥ è¿›é˜¶é—®é¢˜</span></a></h2><h3 id="_7-rabbitmqå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_7-rabbitmqå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—"><span>7. RabbitMQå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼šä¸¤ç§æ–¹å¼</strong></p><p><strong>æ–¹å¼1ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ— æ¶ˆè´¹è€…ï¼‰</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.cancel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">1800000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 30åˆ†é’Ÿ</span></span>
<span class="line"></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;delay.queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ–¹å¼2ï¼šå»¶è¿Ÿæ’ä»¶ï¼ˆæ¨èï¼‰</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_delayed_message_exchange</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-delayed-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;delayed.exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;x-delayed-message&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‘é€æ—¶è®¾ç½®å»¶è¿Ÿæ—¶é—´</span></span>
<span class="line"><span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;x-delay&quot;</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-rabbitmqé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_8-rabbitmqé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›"><span>8. RabbitMQé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. æ™®é€šé›†ç¾¤</strong></p><ul><li>é˜Ÿåˆ—åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹å­˜å‚¨</li><li>å…¶ä»–èŠ‚ç‚¹åªæœ‰å…ƒæ•°æ®</li><li>æ¶ˆè´¹æ—¶ä»å­˜å‚¨èŠ‚ç‚¹æ‹‰å–</li></ul><p><strong>2. é•œåƒé˜Ÿåˆ—</strong></p><ul><li>é˜Ÿåˆ—åœ¨æ‰€æœ‰èŠ‚ç‚¹åŒæ­¥</li><li>é«˜å¯ç”¨ï¼ŒèŠ‚ç‚¹æ•…éšœä¸å½±å“</li><li>æ€§èƒ½æœ‰æ‰€ä¸‹é™</li></ul><p><strong>3. ä»²è£é˜Ÿåˆ—ï¼ˆQuorum Queueï¼‰</strong></p><ul><li>åŸºäºRaftåè®®</li><li>æ›´é«˜çš„æ•°æ®ä¸€è‡´æ€§</li><li>RabbitMQ 3.8+</li></ul><h3 id="_9-å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯" tabindex="-1"><a class="header-anchor" href="#_9-å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯"><span>9. å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>åŸå› åˆ†æï¼š</strong></p><ul><li>ç”Ÿäº§é€Ÿåº¦ &gt; æ¶ˆè´¹é€Ÿåº¦</li><li>æ¶ˆè´¹è€…å¤„ç†æ…¢</li><li>æ¶ˆè´¹è€…å®•æœº</li></ul><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p><strong>1. å¢åŠ æ¶ˆè´¹è€…</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span></span>
<span class="line">    queues <span class="token operator">=</span> <span class="token string">&quot;order.queue&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    concurrency <span class="token operator">=</span> <span class="token string">&quot;5-10&quot;</span>  <span class="token comment">// 5-10ä¸ªæ¶ˆè´¹è€…</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. æé«˜æ¶ˆè´¹é€Ÿåº¦</strong></p><ul><li>ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘</li><li>æ‰¹é‡å¤„ç†</li><li>å¼‚æ­¥å¤„ç†</li></ul><p><strong>3. é™æµ</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é¢„å–100æ¡</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>4. ä¸´æ—¶æ‰©å®¹</strong></p><ul><li>å¯åŠ¨å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹</li><li>å¤„ç†å®Œæ¯•åä¸‹çº¿</li></ul><h3 id="_10-rabbitmqå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹" tabindex="-1"><a class="header-anchor" href="#_10-rabbitmqå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹"><span>10. RabbitMQå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>æ–¹å¼1ï¼šå•é˜Ÿåˆ— + å•æ¶ˆè´¹è€…</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span></span>
<span class="line">    queues <span class="token operator">=</span> <span class="token string">&quot;order.queue&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    concurrency <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span>  <span class="token comment">// åªæœ‰1ä¸ªæ¶ˆè´¹è€…</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ–¹å¼2ï¼šåˆ†åŒº</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// ç›¸åŒè®¢å•IDå‘åˆ°åŒä¸€é˜Ÿåˆ—</span></span>
<span class="line"><span class="token keyword">int</span> queueIndex <span class="token operator">=</span> orderId<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> queueCount<span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;order.queue.&quot;</span> <span class="token operator">+</span> queueIndex<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ³¨æ„ï¼š</strong> ä¿è¯é¡ºåºä¼šé™ä½å¹¶å‘æ€§èƒ½</p><h3 id="_11-rabbitmqå’Œkafkaçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_11-rabbitmqå’Œkafkaçš„åŒºåˆ«"><span>11. RabbitMQå’ŒKafkaçš„åŒºåˆ«ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><table><thead><tr><th>ç‰¹æ€§</th><th>RabbitMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>å®šä½</td><td>æ¶ˆæ¯é˜Ÿåˆ—</td><td>æµå¤„ç†å¹³å°</td></tr><tr><td>ååé‡</td><td>ä¸‡çº§</td><td>ç™¾ä¸‡çº§</td></tr><tr><td>æ¶ˆæ¯å»¶è¿Ÿ</td><td>å¾®ç§’çº§</td><td>æ¯«ç§’çº§</td></tr><tr><td>æ¶ˆæ¯å¯é æ€§</td><td>é«˜</td><td>ä¸€èˆ¬</td></tr><tr><td>æ¶ˆæ¯é¡ºåº</td><td>ä¸€èˆ¬</td><td>é«˜</td></tr><tr><td>è·¯ç”±åŠŸèƒ½</td><td>ä¸°å¯Œ</td><td>ç®€å•</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>ä¼ä¸šåº”ç”¨ã€RPC</td><td>å¤§æ•°æ®ã€æ—¥å¿—</td></tr></tbody></table><p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p><ul><li>é«˜ååé‡ã€æ—¥å¿—æ”¶é›† â†’ Kafka</li><li>å¤æ‚è·¯ç”±ã€å¯é æ€§é«˜ â†’ RabbitMQ</li></ul><h2 id="ğŸ’¼-å®æˆ˜é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ğŸ’¼-å®æˆ˜é—®é¢˜"><span>ğŸ’¼ å®æˆ˜é—®é¢˜</span></a></h2><h3 id="_12-ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨rabbitmqå‰Šå³°" tabindex="-1"><a class="header-anchor" href="#_12-ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨rabbitmqå‰Šå³°"><span>12. ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨RabbitMQå‰Šå³°ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>æµç¨‹ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ Redisé¢„å‡åº“å­˜ â†’ MQé˜Ÿåˆ— â†’ å¼‚æ­¥å¤„ç†è®¢å•</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>å®ç°ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// Controller</span></span>
<span class="line"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/seckill&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckill</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. Redisé¢„å‡åº“å­˜</span></span>
<span class="line">    <span class="token class-name">Long</span> stock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token string">&quot;stock:&quot;</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;åº“å­˜ä¸è¶³&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. å‘é€MQ</span></span>
<span class="line">    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;seckill.queue&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token keyword">new</span> <span class="token class-name">SeckillMessage</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·æ±‚å·²æäº¤&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Consumer</span></span>
<span class="line"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;seckill.queue&quot;</span><span class="token punctuation">,</span> concurrency <span class="token operator">=</span> <span class="token string">&quot;5-10&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleSeckill</span><span class="token punctuation">(</span><span class="token class-name">SeckillMessage</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ‰£å‡æ•°æ®åº“åº“å­˜</span></span>
<span class="line">    <span class="token comment">// åˆ›å»ºè®¢å•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_13-å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_13-å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡"><span>13. å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼šå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§</strong></p><p><strong>æ­¥éª¤ï¼š</strong></p><ol><li>æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</li><li>è®°å½•æ¶ˆæ¯è¡¨ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰</li><li>å‘é€MQæ¶ˆæ¯</li><li>æ¶ˆè´¹è€…å¤„ç†ï¼ˆå¹‚ç­‰æ€§ï¼‰</li><li>å®šæ—¶ä»»åŠ¡è¡¥å¿å¤±è´¥æ¶ˆæ¯</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Transactional</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. æ›´æ–°è®¢å•çŠ¶æ€</span></span>
<span class="line">    orderMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> <span class="token string">&quot;PAID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®°å½•æ¶ˆæ¯è¡¨</span></span>
<span class="line">    <span class="token class-name">TransactionMessage</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    msg<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    msg<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;SENDING&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    messageMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. å‘é€MQ</span></span>
<span class="line">    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order.paid&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. æ›´æ–°æ¶ˆæ¯çŠ¶æ€</span></span>
<span class="line">    msg<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;SENT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    messageMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_14-å¦‚ä½•ç›‘æ§rabbitmq" tabindex="-1"><a class="header-anchor" href="#_14-å¦‚ä½•ç›‘æ§rabbitmq"><span>14. å¦‚ä½•ç›‘æ§RabbitMQï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. ç®¡ç†ç•Œé¢</strong></p><ul><li>é˜Ÿåˆ—æ¶ˆæ¯æ•°</li><li>æ¶ˆè´¹é€Ÿåº¦</li><li>å†…å­˜ä½¿ç”¨</li></ul><p><strong>2. HTTP API</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">15672</span><span class="token operator">/</span>api<span class="token operator">/</span>queues</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>3. Prometheus + Grafana</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_prometheus</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>4. å‘Šè­¦æŒ‡æ ‡</strong></p><ul><li>é˜Ÿåˆ—ç§¯å‹ &gt; 10000</li><li>æ¶ˆè´¹é€Ÿåº¦ &lt; é˜ˆå€¼</li><li>å†…å­˜ä½¿ç”¨ &gt; 80%</li></ul><h3 id="_15-rabbitmqæ€§èƒ½ä¼˜åŒ–å»ºè®®" tabindex="-1"><a class="header-anchor" href="#_15-rabbitmqæ€§èƒ½ä¼˜åŒ–å»ºè®®"><span>15. RabbitMQæ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. ç”Ÿäº§è€…</strong></p><ul><li>æ‰¹é‡å‘é€</li><li>å¼€å¯å‘é€ç¡®è®¤</li><li>ä½¿ç”¨è¿æ¥æ± </li></ul><p><strong>2. æ¶ˆè´¹è€…</strong></p><ul><li>åˆç†è®¾ç½®prefetch</li><li>æ‰¹é‡ACK</li><li>å¢åŠ å¹¶å‘æ•°</li></ul><p><strong>3. é˜Ÿåˆ—</strong></p><ul><li>ä½¿ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼ˆå¤§é‡æ¶ˆæ¯ï¼‰</li><li>è®¾ç½®TTL</li><li>é™åˆ¶é˜Ÿåˆ—é•¿åº¦</li></ul><p><strong>4. é›†ç¾¤</strong></p><ul><li>é•œåƒé˜Ÿåˆ—</li><li>è´Ÿè½½å‡è¡¡</li><li>åˆ†ç‰‡å­˜å‚¨</li></ul><p><strong>5. é…ç½®ä¼˜åŒ–</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cache</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">channel</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">50</span></span>
<span class="line">    <span class="token key atrule">listener</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">simple</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">        <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> 5<span class="token punctuation">-</span><span class="token number">10</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-é«˜é¢‘åœºæ™¯é¢˜" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-é«˜é¢‘åœºæ™¯é¢˜"><span>ğŸ¯ é«˜é¢‘åœºæ™¯é¢˜</span></a></h2><h3 id="_16-å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆ" tabindex="-1"><a class="header-anchor" href="#_16-å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆ"><span>16. å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆï¼Ÿ</span></a></h3>`,118)),a("p",null,[n[1]||(n[1]=a("strong",null,"ç­”æ¡ˆï¼š",-1)),n[2]||(n[2]=s(" è§",-1)),p(t,{to:"/tutorials/java-backend/rabbitmq/04-RabbitMQ%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B.html#%E6%A1%88%E4%BE%8B%E4%B8%80%E8%AE%A2%E5%8D%95%E5%BB%B6%E6%97%B6%E5%8F%96%E6%B6%88"},{default:l(()=>[...n[0]||(n[0]=[s("å®æˆ˜æ¡ˆä¾‹-è®¢å•å»¶æ—¶å–æ¶ˆ",-1)])]),_:1})]),n[6]||(n[6]=e(`<h3 id="_17-å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸ" tabindex="-1"><a class="header-anchor" href="#_17-å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸ"><span>17. å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. æ‰‹åŠ¨ACK</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> cancelCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>2. å¼‚å¸¸æ—¶æ‹’ç»æ¶ˆæ¯</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">processMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡æ–°å…¥é˜Ÿ</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. é‡è¯•æœºåˆ¶</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">listener</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">simple</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">retry</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> <span class="token number">2000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4. æ­»ä¿¡é˜Ÿåˆ—å…œåº•</strong></p><h3 id="_18-æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#_18-æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠ"><span>18. æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ</span></a></h3><p><strong>ç­”æ¡ˆï¼š</strong></p><p><strong>1. å‘é€æ–¹ç¡®è®¤</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">,</span> ack<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// é‡æ–°å‘é€æˆ–è®°å½•æ—¥å¿—</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;æ¶ˆæ¯å‘é€å¤±è´¥: {}&quot;</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. æŒä¹…åŒ–åˆ°æ•°æ®åº“</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// å‘é€å‰è®°å½•</span></span>
<span class="line">messageMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‘é€åæ›´æ–°çŠ¶æ€</span></span>
<span class="line">message<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;SENT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">messageMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. å®šæ—¶è¡¥å¿</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">retryFailedMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> failedMessages <span class="token operator">=</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> msg <span class="token operator">:</span> failedMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ’¡-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-æ€»ç»“"><span>ğŸ’¡ æ€»ç»“</span></a></h2><p><strong>æŒæ¡è¦ç‚¹ï¼š</strong></p><ul><li>âœ… æ¶ˆæ¯å¯é æ€§ä¿è¯ï¼ˆç¡®è®¤æœºåˆ¶ã€æŒä¹…åŒ–ã€ACKï¼‰</li><li>âœ… æ¶ˆæ¯å¹‚ç­‰æ€§ï¼ˆå”¯ä¸€IDã€æ•°æ®åº“ç´¢å¼•ï¼‰</li><li>âœ… æ­»ä¿¡é˜Ÿåˆ—å’Œå»¶è¿Ÿé˜Ÿåˆ—</li><li>âœ… é›†ç¾¤å’Œé«˜å¯ç”¨</li><li>âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li><li>âœ… å®æˆ˜åº”ç”¨åœºæ™¯</li></ul><hr><p><strong>RabbitMQæ•™ç¨‹å®Œç»“ï¼</strong> ğŸ‰</p>`,22)),a("p",null,[n[4]||(n[4]=s("ç»§ç»­å­¦ä¹ å…¶ä»–æŠ€æœ¯æ ˆ â†’ ",-1)),p(t,{to:"/tutorials/java-backend/"},{default:l(()=>[...n[3]||(n[3]=[s("è¿”å›MQç›®å½•",-1)])]),_:1})])])}const b=i(r,[["render",d]]),v=JSON.parse('{"path":"/tutorials/java-backend/rabbitmq/06-RabbitMQmianshiti.html","title":"RabbitMQé¢è¯•é¢˜","lang":"zh-CN","frontmatter":{"title":"RabbitMQé¢è¯•é¢˜"},"headers":[{"level":2,"title":"ğŸ¯ åŸºç¡€çŸ¥è¯†","slug":"ğŸ¯-åŸºç¡€çŸ¥è¯†","link":"#ğŸ¯-åŸºç¡€çŸ¥è¯†","children":[{"level":3,"title":"1. ä»€ä¹ˆæ˜¯RabbitMQï¼Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ","slug":"_1-ä»€ä¹ˆæ˜¯rabbitmq-æœ‰ä»€ä¹ˆç‰¹ç‚¹","link":"#_1-ä»€ä¹ˆæ˜¯rabbitmq-æœ‰ä»€ä¹ˆç‰¹ç‚¹","children":[]},{"level":3,"title":"2. RabbitMQçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›ï¼Ÿ","slug":"_2-rabbitmqçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›","link":"#_2-rabbitmqçš„æ ¸å¿ƒæ¦‚å¿µæœ‰å“ªäº›","children":[]},{"level":3,"title":"3. RabbitMQçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›ï¼Ÿ","slug":"_3-rabbitmqçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›","link":"#_3-rabbitmqçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›","children":[]},{"level":3,"title":"4. å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ","slug":"_4-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±","link":"#_4-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±","children":[]},{"level":3,"title":"5. å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ","slug":"_5-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹","link":"#_5-å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹","children":[]},{"level":3,"title":"6. ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ","slug":"_6-ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—-æœ‰ä»€ä¹ˆç”¨","link":"#_6-ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—-æœ‰ä»€ä¹ˆç”¨","children":[]}]},{"level":2,"title":"ğŸ”¥ è¿›é˜¶é—®é¢˜","slug":"ğŸ”¥-è¿›é˜¶é—®é¢˜","link":"#ğŸ”¥-è¿›é˜¶é—®é¢˜","children":[{"level":3,"title":"7. RabbitMQå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ","slug":"_7-rabbitmqå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—","link":"#_7-rabbitmqå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—","children":[]},{"level":3,"title":"8. RabbitMQé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ","slug":"_8-rabbitmqé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›","link":"#_8-rabbitmqé›†ç¾¤æ¨¡å¼æœ‰å“ªäº›","children":[]},{"level":3,"title":"9. å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯ï¼Ÿ","slug":"_9-å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯","link":"#_9-å¦‚ä½•å¤„ç†æ¶ˆæ¯å †ç§¯","children":[]},{"level":3,"title":"10. RabbitMQå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹ï¼Ÿ","slug":"_10-rabbitmqå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹","link":"#_10-rabbitmqå¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹","children":[]},{"level":3,"title":"11. RabbitMQå’ŒKafkaçš„åŒºåˆ«ï¼Ÿ","slug":"_11-rabbitmqå’Œkafkaçš„åŒºåˆ«","link":"#_11-rabbitmqå’Œkafkaçš„åŒºåˆ«","children":[]}]},{"level":2,"title":"ğŸ’¼ å®æˆ˜é—®é¢˜","slug":"ğŸ’¼-å®æˆ˜é—®é¢˜","link":"#ğŸ’¼-å®æˆ˜é—®é¢˜","children":[{"level":3,"title":"12. ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨RabbitMQå‰Šå³°ï¼Ÿ","slug":"_12-ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨rabbitmqå‰Šå³°","link":"#_12-ç§’æ€ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨rabbitmqå‰Šå³°","children":[]},{"level":3,"title":"13. å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ","slug":"_13-å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡","link":"#_13-å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡","children":[]},{"level":3,"title":"14. å¦‚ä½•ç›‘æ§RabbitMQï¼Ÿ","slug":"_14-å¦‚ä½•ç›‘æ§rabbitmq","link":"#_14-å¦‚ä½•ç›‘æ§rabbitmq","children":[]},{"level":3,"title":"15. RabbitMQæ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼Ÿ","slug":"_15-rabbitmqæ€§èƒ½ä¼˜åŒ–å»ºè®®","link":"#_15-rabbitmqæ€§èƒ½ä¼˜åŒ–å»ºè®®","children":[]}]},{"level":2,"title":"ğŸ¯ é«˜é¢‘åœºæ™¯é¢˜","slug":"ğŸ¯-é«˜é¢‘åœºæ™¯é¢˜","link":"#ğŸ¯-é«˜é¢‘åœºæ™¯é¢˜","children":[{"level":3,"title":"16. å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆï¼Ÿ","slug":"_16-å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆ","link":"#_16-å¦‚ä½•å®ç°è®¢å•30åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆ","children":[]},{"level":3,"title":"17. å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸï¼Ÿ","slug":"_17-å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸ","link":"#_17-å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸€å®šå¤„ç†æˆåŠŸ","children":[]},{"level":3,"title":"18. æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ","slug":"_18-æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠ","link":"#_18-æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠ","children":[]}]},{"level":2,"title":"ğŸ’¡ æ€»ç»“","slug":"ğŸ’¡-æ€»ç»“","link":"#ğŸ’¡-æ€»ç»“","children":[]}],"git":{"createdTime":1765249786000,"updatedTime":1765249786000,"contributors":[{"name":"CambridgeFoldingKnife","email":"3144253125@qq.com","commits":1}]},"filePathRelative":"tutorials/java-backend/rabbitmq/06-RabbitMQé¢è¯•é¢˜.md"}');export{b as comp,v as data};
